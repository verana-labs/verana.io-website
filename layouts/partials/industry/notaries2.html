{{ $page := . }}
{{ $params := $page.Params }}
{{ $sidebar := $params.sidebar }}
{{ $problem := $params.problem }}
{{ $solution := $params.solution }}
{{ $workflows := $params.workflows }}
{{ $business := $params.business_models }}
{{ $conclusion := $params.conclusion }}
{{ $cta := $params.cta }}
{{ $related := $params.related }}

<section id="main-content" class="bg-black py-20 lg:py-32">
  <div class="container mx-auto px-6">
    <div class="max-w-6xl mx-auto">
      <div class="grid lg:grid-cols-4 gap-12">
        {{ with $sidebar }}
          <aside id="sidebar-nav" class="lg:col-span-1">
            <div class="bg-gray-900 border border-gray-700 rounded-2xl p-6 sticky top-24" data-sidebar-sticky>
              {{ with .title }}<h3 class="text-lg font-semibold text-white mb-6">{{ . }}</h3>{{ end }}
              {{ with .nav }}
                <nav class="space-y-3">
                  {{ range . }}
                    {{ $label := .label | default .title | default .name }}
                    {{ $href := .url | default .href | default "#" }}
                    {{ $isActive := cond (isset . "active") (.active) false }}
                    <a href="{{ $href }}" class="block {{ if $isActive }}text-verana font-medium{{ else }}text-gray-400 hover:text-white transition-colors duration-200{{ end }}" data-nav-link>
                      <span>{{ $label }}</span>
                    </a>
                  {{ end }}
                </nav>
              {{ end }}
              {{ with .quick_links }}
                <div class="mt-8 pt-6 border-t border-gray-700">
                  {{ with .title }}<h4 class="text-sm font-semibold text-white mb-4">{{ . }}</h4>{{ end }}
                  <div class="space-y-2">
                    {{ range .items }}
                      {{ $label := .label | default .title | default .name }}
                      {{ $href := .url | default .href | default "#" }}
                      <a href="{{ $href }}" class="block text-sm text-gray-400 hover:text-white transition-colors duration-200"{{ if strings.HasPrefix $href "http" }} target="_blank" rel="noopener noreferrer"{{ end }}>{{ $label }}</a>
                    {{ end }}
                  </div>
                </div>
              {{ end }}
            </div>
          </aside>
        {{ end }}

        <div id="content-area" class="lg:col-span-3">
          {{ with $problem }}
            <div id="{{ .id | default "problem-statement" }}" class="mb-16">
              {{ with .title }}<h2 class="text-3xl lg:text-4xl font-bold text-white mb-8 flex items-center">
                <i class="fa-solid fa-file-contract text-red-400 mr-4"></i>
                <span>{{ . | markdownify }}</span>
              </h2>{{ end }}
              {{ with .intro }}<p class="text-lg text-gray-300 leading-relaxed mb-8">{{ . | markdownify }}</p>{{ end }}

              {{ with .issuing }}
                <div id="issuing-process" class="mb-12">
                  {{ with .title }}<h3 class="text-2xl font-semibold text-white mb-6 flex items-center">
                    <i class="fa-solid fa-pen-to-square text-blue-400 mr-3"></i>
                    <span>{{ . | markdownify }}</span>
                  </h3>{{ end }}
                  <div class="space-y-6">
                    {{ range .bullets }}
                      <div class="flex items-start space-x-3">
                        <div class="w-2 h-2 bg-blue-400 rounded-full mt-2"></div>
                        <p class="text-gray-300">{{ .text | markdownify }}</p>
                      </div>
                    {{ end }}
                  </div>
                </div>
              {{ end }}

              {{ with .revoking }}
                <div id="revoking-process" class="mb-12">
                  {{ with .title }}<h3 class="text-2xl font-semibold text-white mb-6 flex items-center">
                    <i class="fa-solid fa-ban text-orange-400 mr-3"></i>
                    <span>{{ . | markdownify }}</span>
                  </h3>{{ end }}
                  <div class="space-y-6">
                    {{ range .bullets }}
                      <div class="flex items-start space-x-3">
                        <div class="w-2 h-2 bg-orange-400 rounded-full mt-2"></div>
                        <p class="text-gray-300">{{ .text | markdownify }}</p>
                      </div>
                    {{ end }}
                  </div>
                </div>
              {{ end }}

              {{ with .using }}
                <div id="using-process" class="mb-8">
                  {{ with .title }}<h3 class="text-2xl font-semibold text-white mb-6 flex items-center">
                    <i class="fa-solid fa-university text-green-400 mr-3"></i>
                    <span>{{ . | markdownify }}</span>
                  </h3>{{ end }}
                  {{ with .intro }}<p class="text-gray-300 mb-6">{{ . | markdownify }}</p>{{ end }}
                  <div class="space-y-6">
                    {{ range .bullets }}
                      <div class="flex items-start space-x-3">
                        <div class="w-2 h-2 bg-green-400 rounded-full mt-2"></div>
                        <p class="text-gray-300">{{ .text | markdownify }}</p>
                      </div>
                    {{ end }}
                  </div>
                </div>
              {{ end }}

              {{ with $problem.illustration }}
                {{ $wrapperClass := .wrapper_class | default "flex items-center justify-center bg-gray-900 border border-gray-700 rounded-2xl p-8" }}
                {{ $imgClass := .img_class | default "w-full max-w-lg rounded-xl" }}
                <div class="{{ $wrapperClass }}">
                  <img class="{{ $imgClass }}" src="{{ .src }}" alt="{{ .alt }}" loading="lazy"{{ with .width }} width="{{ . }}"{{ end }}{{ with .height }} height="{{ . }}"{{ end }} />
                </div>
              {{ end }}

              {{ with $problem.friction_callout }}
                <div class="mt-6 p-6 bg-red-500/10 border border-red-500/30 rounded-xl">
                  <p class="text-red-200 leading-relaxed">
                    <i class="fa-solid fa-exclamation-circle text-red-400 mr-2"></i>
                    {{ . | markdownify }}
                  </p>
                </div>
              {{ end }}
            </div>
          {{ end }}

          {{ with $solution }}
            <div id="{{ .id | default "solution-section" }}" class="mb-16">
              {{ with .title }}<h2 class="text-3xl lg:text-4xl font-bold text-white mb-8 flex items-center">
                <i class="fa-solid fa-lightbulb text-verana mr-4"></i>
                <span>{{ . | markdownify }}</span>
              </h2>{{ end }}
              {{ with .intro }}<p class="text-lg text-gray-300 leading-relaxed mb-8">{{ . | markdownify }}</p>{{ end }}

              {{ with .digital_ecosystem }}
                <div id="digital-ecosystem" class="mb-12">
                  {{ with .title }}<h3 class="text-2xl font-semibold text-white mb-6 flex items-center">
                    <i class="fa-solid fa-diagram-project text-verana mr-3"></i>
                    <span>{{ . | markdownify }}</span>
                  </h3>{{ end }}
                  {{ with .intro }}<p class="text-lg text-gray-300 leading-relaxed mb-8">{{ . | markdownify }}</p>{{ end }}
                  <div class="space-y-8">
                    {{ range .steps }}
                      <div class="bg-black border border-gray-600 rounded-xl p-6">
                        <h4 class="text-xl font-semibold text-white mb-4 flex items-center">
                          <span class="w-8 h-8 bg-verana rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">{{ .number }}</span>
                          <span>{{ .title | markdownify }}</span>
                        </h4>
                        <div class="space-y-4 ml-11">
                          {{ range .bullets }}
                            <div class="flex items-start space-x-3">
                              <div class="w-2 h-2 bg-verana rounded-full mt-2"></div>
                              <p class="text-gray-300">{{ .text | markdownify }}</p>
                            </div>
                          {{ end }}
                        </div>
                      </div>
                    {{ end }}
                  </div>
                </div>
              {{ end }}

              {{ with .implementation_diagram }}
                <div id="implementation-diagram" class="mb-12">
                  {{ with .title }}<h3 class="text-2xl font-semibold text-white mb-6 flex items-center">
                    <span class="w-8 h-8 bg-verana rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">2</span>
                    <span>{{ . | markdownify }}</span>
                  </h3>{{ end }}
                  {{ with .intro }}<p class="text-gray-300 mb-6">{{ . | markdownify }}</p>{{ end }}
                  <div class="bg-black border border-gray-600 rounded-2xl p-8">
                    {{ with .diagram }}
                      <div class="text-center mb-8">
                        <div class="w-full rounded-xl border border-gray-700/60 bg-black/40 p-2">
                          {{ $page.RenderString . }}
                        </div>
                      </div>
                    {{ end }}
                    {{ with .cards }}
                      <div class="grid md:grid-cols-3 gap-6 mt-10">
                        {{ range . }}
                          <div class="bg-black rounded-xl p-6 text-center">
                            <div class="w-16 h-16 {{ .icon_bg | default "bg-verana/20" }} rounded-xl flex items-center justify-center mx-auto mb-4">
                              <i class="{{ .icon | default "fa-solid fa-circle" }} {{ .icon_color | default "text-white" }} text-2xl"></i>
                            </div>
                            {{ with .title }}<h4 class="text-lg font-semibold text-white mb-2">{{ . | markdownify }}</h4>{{ end }}
                            {{ with .text }}<p class="text-gray-300 text-sm">{{ . | markdownify }}</p>{{ end }}
                          </div>
                        {{ end }}
                      </div>
                    {{ end }}
                    <div class="space-y-6">
                      {{ with .root }}
                        <div class="flex justify-center">
                          <div class="bg-gradient-to-r from-cyan-500/20 to-cyan-400/20 border border-cyan-400/50 rounded-xl p-4 text-center">
                            <div class="w-12 h-12 bg-cyan-400/20 rounded-lg flex items-center justify-center mx-auto mb-2">
                              <i class="fa-solid fa-crown text-cyan-400"></i>
                            </div>
                            <h5 class="text-white font-semibold">{{ .title }}</h5>
                            <p class="text-xs text-cyan-300">{{ .role }}</p>
                            <p class="text-xs text-gray-400">{{ .did }}</p>
                          </div>
                        </div>
                      {{ end }}
                      {{ with .states }}
                        <div class="flex justify-center"><div class="w-px h-8 bg-gray-600"></div></div>
                        <div class="flex justify-center space-x-12">
                          {{ range . }}
                            <div class="bg-gray-800 border border-gray-600 rounded-xl p-4 text-center">
                              <div class="w-10 h-10 bg-gray-600/20 rounded-lg flex items-center justify-center mx-auto mb-2">
                                <i class="fa-solid fa-building text-gray-400"></i>
                              </div>
                              <h5 class="text-white font-semibold text-sm">{{ .title }}</h5>
                              <p class="text-xs text-gray-300">{{ .role }}</p>
                              {{ with .did }}<p class="text-xs text-gray-500">{{ . }}</p>{{ end }}
                            </div>
                          {{ end }}
                        </div>
                        <div class="flex justify-center space-x-12">
                          {{ range . }}<div class="w-px h-8 bg-gray-600"></div>{{ end }}
                        </div>
                      {{ end }}
                      {{ with .notaries }}
                        <div class="flex justify-center space-x-4">
                          {{ range . }}
                            <div class="bg-purple-500/10 border border-purple-400/50 rounded-lg p-3 text-center">
                              <div class="w-8 h-8 bg-purple-400/20 rounded-lg flex items-center justify-center mx-auto mb-1">
                                <i class="fa-solid fa-stamp text-purple-400 text-xs"></i>
                              </div>
                              <h6 class="text-white font-semibold text-xs">{{ .title }}</h6>
                              {{ with .role }}<p class="text-xs text-purple-300">{{ . }}</p>{{ end }}
                            </div>
                          {{ end }}
                        </div>
                      {{ end }}
                    </div>
                  </div>
                </div>
              {{ end }}
            </div>
          {{ end }}

          {{ with $workflows }}
            <div id="{{ .id | default "new-workflows" }}" class="mb-16">
              {{ with .title }}<h2 class="text-3xl lg:text-4xl font-bold text-white mb-8 flex items-center">
                <i class="fa-solid fa-arrows-rotate text-verana mr-4"></i>
                <span>{{ . | markdownify }}</span>
              </h2>{{ end }}

              {{ with .issuing }}
                <div id="issuing-with-vc" class="mb-16">
                  {{ with .title }}<h3 class="text-2xl font-semibold text-white mb-6 flex items-center">
                    <i class="fa-solid fa-certificate text-green-400 mr-3"></i>
                    <span>{{ . | markdownify }}</span>
                  </h3>{{ end }}
                  <div class="bg-gray-900 border border-gray-700 rounded-2xl p-8">
                    {{ with .intro }}<p class="text-lg text-gray-300 leading-relaxed mb-8">{{ . | markdownify }}</p>{{ end }}
                    <div class="space-y-6">
                      {{ range .bullets }}
                        <div class="flex items-center space-x-4">
                          <div class="w-8 h-8 bg-green-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="{{ .icon | default "fa-solid fa-check" }} text-green-400 text-sm"></i>
                          </div>
                          <p class="text-gray-300 leading-relaxed">{{ .text | markdownify }}</p>
                        </div>
                      {{ end }}
                    </div>
                    {{ with .image }}
                      {{ $wrapperClass := .wrapper_class | default "text-center mt-10" }}
                      {{ $imgClass := .img_class | default "w-full max-w-lg rounded-xl" }}
                      <div class="{{ $wrapperClass }}">
                        <img class="{{ $imgClass }}" src="{{ .src }}" alt="{{ .alt }}" loading="lazy"{{ with .width }} width="{{ . }}"{{ end }}{{ with .height }} height="{{ . }}"{{ end }} />
                      </div>
                    {{ end }}
                  </div>
                </div>
              {{ end }}

              {{ with .revoking }}
                <div id="revoking-with-vc" class="mb-16">
                  {{ with .title }}<h3 class="text-2xl font-semibold text-white mb-6 flex items-center">
                    <i class="fa-solid fa-ban text-red-400 mr-3"></i>
                    <span>{{ . | markdownify }}</span>
                  </h3>{{ end }}
                  <div class="bg-gray-900 border border-gray-700 rounded-2xl p-8">
                    <div class="space-y-6">
                      {{ range .bullets }}
                        <div class="flex items-center space-x-4">
                          <div class="w-8 h-8 bg-red-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="{{ .icon | default "fa-solid fa-check" }} text-red-400 text-sm"></i>
                          </div>
                          <p class="text-gray-300 leading-relaxed">{{ .text | markdownify }}</p>
                        </div>
                      {{ end }}
                    </div>
                    {{ with .image }}
                      {{ $wrapperClass := .wrapper_class | default "text-center mt-10" }}
                      {{ $imgClass := .img_class | default "w-full max-w-lg rounded-xl" }}
                      <div class="{{ $wrapperClass }}">
                        <img class="{{ $imgClass }}" src="{{ .src }}" alt="{{ .alt }}" loading="lazy"{{ with .width }} width="{{ . }}"{{ end }}{{ with .height }} height="{{ . }}"{{ end }} />
                      </div>
                    {{ end }}
                  </div>
                </div>
              {{ end }}

              {{ with .using }}
                <div id="using-with-vc" class="mb-16">
                  {{ with .title }}<h3 class="text-2xl font-semibold text-white mb-6 flex items-center">
                    <i class="fa-solid fa-building-columns text-blue-400 mr-3"></i>
                    <span>{{ . | markdownify }}</span>
                  </h3>{{ end }}
                  <div class="bg-gray-900 border border-gray-700 rounded-2xl p-8">
                    {{ with .intro }}<p class="text-lg text-gray-300 leading-relaxed mb-8">{{ . | markdownify }}</p>{{ end }}
                    <div class="space-y-6">
                      {{ range .bullets }}
                        <div class="flex items-center space-x-4">
                          <div class="w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="{{ .icon | default "fa-solid fa-check" }} text-blue-400 text-sm"></i>
                          </div>
                          <p class="text-gray-300 leading-relaxed">{{ .text | markdownify }}</p>
                        </div>
                      {{ end }}
                    </div>
                    {{ with .image }}
                      {{ $wrapperClass := .wrapper_class | default "text-center mt-10" }}
                      {{ $imgClass := .img_class | default "w-full max-w-lg rounded-xl" }}
                      <div class="{{ $wrapperClass }}">
                        <img class="{{ $imgClass }}" src="{{ .src }}" alt="{{ .alt }}" loading="lazy"{{ with .width }} width="{{ . }}"{{ end }}{{ with .height }} height="{{ . }}"{{ end }} />
                      </div>
                    {{ end }}
                  </div>
                </div>
              {{ end }}

              {{ with .verification_illustration }}
                <div class="flex items-center justify-center bg-gray-900 border border-gray-700 rounded-2xl p-8">
                  <img class="w-full max-w-lg rounded-xl" src="{{ .src }}" alt="{{ .alt }}" loading="lazy" />
                </div>
              {{ end }}
            </div>
          {{ end }}

          {{ with $business }}
            <div id="business-models" class="mb-16">
              {{ with .title }}<h2 class="text-3xl lg:text-4xl font-bold text-white mb-8 flex items-center">
                <i class="fa-solid fa-eye-slash text-verana mr-4"></i>
                <span>{{ . | markdownify }}</span>
              </h2>{{ end }}
              {{ with .intro }}<p class="text-lg text-gray-300 leading-relaxed">{{ . | markdownify }}</p>{{ end }}
              {{ with .cards }}
                <div class="grid md:grid-cols-3 gap-6 mt-8">
                  {{ range . }}
                    <div class="bg-black border border-gray-600 rounded-xl p-6 text-center">
                      <div class="w-12 h-12 {{ .icon_bg | default "bg-verana/20" }} rounded-xl flex items-center justify-center mx-auto mb-4">
                        <i class="{{ .icon | default "fa-solid fa-circle" }} {{ .icon_color | default "text-white" }} text-xl"></i>
                      </div>
                      {{ with .title }}<h4 class="text-lg font-semibold text-white mb-2">{{ . | markdownify }}</h4>{{ end }}
                      {{ with .text }}<p class="text-gray-300 text-sm">{{ . | markdownify }}</p>{{ end }}
                    </div>
                  {{ end }}
                </div>
              {{ end }}
            </div>
          {{ end }}

          {{ with $conclusion }}
            <div id="{{ .id | default "conclusion" }}" class="mb-16">
              {{ with .title }}<h2 class="text-3xl lg:text-4xl font-bold text-white mb-8 flex items-center">
                <i class="fa-solid fa-trophy text-verana mr-4"></i>
                <span>{{ . | markdownify }}</span>
              </h2>{{ end }}
              {{ with .intro }}<p class="text-lg text-gray-300 leading-relaxed mb-8">{{ . | markdownify }}</p>{{ end }}
              {{ with .benefits }}
                <div class="bg-gradient-to-r from-verana/10 to-verana-light/10 border border-verana/30 rounded-2xl p-8">
                  <div class="grid md:grid-cols-2 gap-8">
                    {{ range . }}
                      <div class="flex items-start space-x-4">
                        <div class="w-8 h-8 {{ .icon_bg | default "bg-verana/20" }} rounded-lg flex items-center justify-center flex-shrink-0 mt-1">
                          <i class="{{ .icon | default "fa-solid fa-circle" }} {{ .icon_color | default "text-white" }} text-sm"></i>
                        </div>
                        <p class="text-gray-300">{{ .text | markdownify }}</p>
                      </div>
                    {{ end }}
                  </div>
                  {{ with $conclusion.callout }}
                    <div class="mt-8 p-6 bg-verana/10 border border-verana/30 rounded-xl text-center">
                      <p class="text-verana-light text-lg font-semibold">{{ . | markdownify }}</p>
                    </div>
                  {{ end }}
                </div>
              {{ end }}
            </div>
          {{ end }}

          {{ with $cta }}
            <div id="{{ .id | default "page-cta" }}" class="bg-gradient-to-r from-verana/10 to-verana-light/10 border border-verana/30 rounded-2xl p-12 text-center">
              {{ with .title }}<h2 class="text-3xl font-bold text-white mb-4">{{ . | markdownify }}</h2>{{ end }}
              {{ with .text }}<p class="text-xl text-gray-300 mb-8 max-w-2xl mx-auto">{{ . | markdownify }}</p>{{ end }}
              <div class="flex flex-col sm:flex-row justify-center items-center gap-6">
                {{ with .primary }}
                  {{ $href := .url | default "#" }}
                  <a href="{{ $href }}" class="bg-verana hover:bg-verana-dark text-white px-8 py-4 rounded-xl font-semibold text-lg transition-all duration-200 hover:scale-105 flex items-center space-x-2"{{ if strings.HasPrefix $href "http" }} target="_blank" rel="noopener noreferrer"{{ end }}>
                    {{ with .icon }}<i class="{{ . }}"></i>{{ end }}
                    <span>{{ .label | default "Get Started" }}</span>
                  </a>
                {{ end }}
                {{ with .secondary }}
                  {{ $href := .url | default "#" }}
                  <a href="{{ $href }}" class="border-2 border-gray-600 hover:border-verana text-white px-8 py-4 rounded-xl font-semibold text-lg transition-all duration-200 hover:scale-105"{{ if strings.HasPrefix $href "http" }} target="_blank" rel="noopener noreferrer"{{ end }}>{{ .label | default "Learn More" }}</a>
                {{ end }}
              </div>
            </div>
          {{ end }}
        </div>
      </div>
    </div>
  </div>
</section>

{{ with $related }}
  <section id="related-content" class="bg-gray-900 py-20">
    <div class="container mx-auto px-6">
      <div class="max-w-6xl mx-auto">
        {{ with .title }}<h2 class="text-3xl lg:text-4xl font-bold text-white mb-12 text-center">{{ . | markdownify }}</h2>{{ end }}
        {{ with .items }}
          <div class="grid md:grid-cols-3 gap-8">
            {{ range . }}
              {{ $href := .url | default .href | default "#" }}
              <div class="bg-black border border-gray-700 rounded-2xl p-8 hover:border-verana/50 transition-all duration-300 hover:scale-105 group">
                <div class="w-12 h-12 {{ .icon.bg | default "bg-verana/20" }} rounded-xl flex items-center justify-center mb-6">
                  <i class="{{ .icon.name | default "fa-solid fa-circle" }} {{ .icon.color | default "text-white" }} text-xl"></i>
                </div>
                {{ with .title }}<h3 class="text-xl font-semibold text-white mb-4">{{ . | markdownify }}</h3>{{ end }}
                {{ with .text }}<p class="text-gray-300 mb-6 leading-relaxed">{{ . | markdownify }}</p>{{ end }}
                <a href="{{ $href }}" class="inline-flex items-center space-x-2 text-verana hover:text-verana-light font-medium group-hover:translate-x-1 transition-all duration-200"{{ if strings.HasPrefix $href "http" }} target="_blank" rel="noopener noreferrer"{{ end }}>
                  <span>{{ .cta_label | default "Learn More" }}</span>
                  <i class="fa-solid fa-arrow-right text-sm"></i>
                </a>
              </div>
            {{ end }}
          </div>
        {{ end }}
      </div>
    </div>
  </section>
{{ end }}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const sidebar = document.querySelector('[data-sidebar-sticky]');
    if (!sidebar) return;

    const updateTop = () => {
      const header = document.getElementById('header');
      const offset = header ? header.getBoundingClientRect().height : 0;
      sidebar.style.top = Math.max(96, offset + 16) + 'px';
    };
    updateTop();
    window.addEventListener('resize', updateTop);

    const links = Array.from(sidebar.querySelectorAll('[data-nav-link]'));
    if (!links.length) return;

    const sectionMap = new Map();

    links.forEach(link => {
      const href = link.getAttribute('href');
      if (!href || !href.startsWith('#')) return;
      const id = decodeURIComponent(href.slice(1));
      const section = document.getElementById(id);
      if (!section) return;
      if (!sectionMap.has(id)) {
        sectionMap.set(id, { element: section, links: [] });
      }
      sectionMap.get(id).links.push(link);
    });

    if (!sectionMap.size) return;

    const setActive = id => {
      sectionMap.forEach((value, key) => {
        value.links.forEach(link => {
          if (key === id) {
            link.classList.add('text-verana', 'font-medium');
            link.classList.remove('text-gray-400');
            link.setAttribute('aria-current', 'true');
          } else {
            link.classList.remove('text-verana', 'font-medium');
            link.classList.add('text-gray-400');
            link.removeAttribute('aria-current');
          }
        });
      });
    };

    const observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          setActive(entry.target.id);
        }
      });
    }, {
      rootMargin: '-40% 0px -40% 0px',
      threshold: [0, 1]
    });

    sectionMap.forEach(value => observer.observe(value.element));

    const headerOffset = () => {
      const header = document.getElementById('header') || document.querySelector('header');
      return header ? header.offsetHeight + 24 : 120;
    };

    links.forEach(link => {
      const href = link.getAttribute('href');
      if (!href || !href.startsWith('#')) return;
      link.addEventListener('click', event => {
        const id = decodeURIComponent(href.slice(1));
        const target = document.getElementById(id);
        if (!target) return;
        event.preventDefault();
        const elementPosition = target.getBoundingClientRect().top + window.scrollY;
        window.scrollTo({ top: elementPosition - headerOffset(), behavior: 'smooth' });
        history.replaceState(null, '', `#${id}`);
        setActive(id);
      });
    });

    const initialId = location.hash ? decodeURIComponent(location.hash.slice(1)) : null;
    if (initialId && sectionMap.has(initialId)) {
      setActive(initialId);
    } else {
      const firstEntry = sectionMap.keys().next();
      if (!firstEntry.done) {
        setActive(firstEntry.value);
      }
    }
  });
</script>
