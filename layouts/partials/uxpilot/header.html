{{ $siteNavMain := .Site.Params.nav.main }}
{{ $navScratch := newScratch }}
{{ $navScratch.Set "items" (slice) }}

{{ if .Params.nav.items }}
  {{ range .Params.nav.items }}
    {{ $itemScratch := newScratch }}
    {{ $itemScratch.Set "label" (or .label (or .title .name)) }}

    {{ with .href }}{{ $itemScratch.Set "href" . }}{{ end }}
    {{ if not ($itemScratch.Get "href") }}{{ with .url }}{{ $itemScratch.Set "href" . }}{{ end }}{{ end }}

    {{ $childrenScratch := newScratch }}
    {{ $childrenScratch.Set "children" (slice) }}
    {{ with .children }}
      {{ range . }}
        {{ $childLabel := or .label (or .title .name) }}
        {{ $childHref := or .href .url }}
        {{ if and $childLabel $childHref }}
          {{ $childrenScratch.Add "children" (slice (dict "label" $childLabel "href" $childHref)) }}
        {{ end }}
      {{ end }}
    {{ end }}
    {{ $itemScratch.Set "children" ($childrenScratch.Get "children") }}

    {{ $labelValue := $itemScratch.Get "label" }}
    {{ $childrenValue := $itemScratch.Get "children" }}
    {{ if and $labelValue (eq (len $childrenValue) 0) $siteNavMain }}
      {{ $labelLower := lower (printf "%s" $labelValue) }}
      {{ range $siteNavMain }}
        {{ $siteLabel := or .label (or .title .name) }}
        {{ if and $siteLabel (eq (lower (printf "%s" $siteLabel)) $labelLower) }}
          {{ $siteChildrenScratch := newScratch }}
          {{ $siteChildrenScratch.Set "children" (slice) }}
          {{ with .children }}
            {{ range . }}
              {{ $childLabel := or .label (or .title .name) }}
              {{ $childHref := or .href .url }}
              {{ if and $childLabel $childHref }}
                {{ $siteChildrenScratch.Add "children" (slice (dict "label" $childLabel "href" $childHref)) }}
              {{ end }}
            {{ end }}
          {{ end }}
          {{ if gt (len ($siteChildrenScratch.Get "children")) 0 }}
            {{ $itemScratch.Set "children" ($siteChildrenScratch.Get "children") }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}

    {{ if and (not ($itemScratch.Get "href")) (gt (len ($itemScratch.Get "children")) 0) }}
      {{ $firstChild := index ($itemScratch.Get "children") 0 }}
      {{ $itemScratch.Set "href" (index $firstChild "href") }}
    {{ end }}

    {{ $label := $itemScratch.Get "label" }}
    {{ $href := $itemScratch.Get "href" }}
    {{ $children := $itemScratch.Get "children" }}
    {{ if $label }}
      {{ $navScratch.Add "items" (slice (dict "label" $label "href" $href "children" $children)) }}
    {{ end }}
  {{ end }}
{{ else if .Site.Params.nav.main }}
  {{ range .Site.Params.nav.main }}
    {{ $itemScratch := newScratch }}
    {{ $itemScratch.Set "label" (or .label (or .title .name)) }}

    {{ with .href }}{{ $itemScratch.Set "href" . }}{{ end }}
    {{ if not ($itemScratch.Get "href") }}{{ with .url }}{{ $itemScratch.Set "href" . }}{{ end }}{{ end }}

    {{ $childrenScratch := newScratch }}
    {{ $childrenScratch.Set "children" (slice) }}
    {{ with .children }}
      {{ range . }}
        {{ $childLabel := or .label (or .title .name) }}
        {{ $childHref := or .href .url }}
        {{ if and $childLabel $childHref }}
          {{ $childrenScratch.Add "children" (slice (dict "label" $childLabel "href" $childHref)) }}
        {{ end }}
      {{ end }}
    {{ end }}
    {{ $itemScratch.Set "children" ($childrenScratch.Get "children") }}

    {{ if and (not ($itemScratch.Get "href")) (gt (len ($itemScratch.Get "children")) 0) }}
      {{ $firstChild := index ($itemScratch.Get "children") 0 }}
      {{ $itemScratch.Set "href" (index $firstChild "href") }}
    {{ end }}

    {{ $label := $itemScratch.Get "label" }}
    {{ $href := $itemScratch.Get "href" }}
    {{ $children := $itemScratch.Get "children" }}
    {{ if $label }}
      {{ $navScratch.Add "items" (slice (dict "label" $label "href" $href "children" $children)) }}
    {{ end }}
  {{ end }}
{{ else }}
  {{ range .Site.Menus.main }}
    {{ $itemScratch := newScratch }}
    {{ $itemScratch.Set "label" .Name }}
    {{ $itemScratch.Set "href" .URL }}

    {{ $childrenScratch := newScratch }}
    {{ $childrenScratch.Set "children" (slice) }}
    {{ if .HasChildren }}
      {{ range .Children }}
        {{ $childrenScratch.Add "children" (slice (dict "label" .Name "href" .URL)) }}
      {{ end }}
    {{ end }}
    {{ $itemScratch.Set "children" ($childrenScratch.Get "children") }}

    {{ if and (not ($itemScratch.Get "href")) (gt (len ($itemScratch.Get "children")) 0) }}
      {{ $firstChild := index ($itemScratch.Get "children") 0 }}
      {{ $itemScratch.Set "href" (index $firstChild "href") }}
    {{ end }}

    {{ $label := $itemScratch.Get "label" }}
    {{ $href := $itemScratch.Get "href" }}
    {{ $children := $itemScratch.Get "children" }}
    {{ if $label }}
      {{ $navScratch.Add "items" (slice (dict "label" $label "href" $href "children" $children)) }}
    {{ end }}
  {{ end }}
{{ end }}

{{ $navItems := $navScratch.Get "items" }}
{{ $logo := or .Params.header.logo .Site.Params.header.logo "/images/purple/logo.svg" }}
<header id="header" class="bg-black/75 backdrop-blur-lg border-b border-gray-800/50 sticky top-0 z-50">
  <div class="container mx-auto px-6 py-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <a href="/" class="flex items-center space-x-4 cursor-pointer">
          <span class="flex h-12 w-12 items-center justify-center rounded-lg bg-gradient-to-br from-verana to-verana-light shadow-lg shadow-verana/30">
            <img src="{{ $logo }}" alt="{{ .Site.Title }} logo" class="h-8 w-auto" />
          </span>
          <span class="text-2xl font-bold text-white">{{ .Site.Title }}</span>
        </a>
      </div>
      <nav class="hidden xl:flex items-center space-x-10">
        {{ range $item := $navItems }}
          {{ $hasChildren := gt (len $item.children) 0 }}
          <div class="relative group">
            <a class="text-gray-300 hover:text-white flex items-center space-x-1 transition-colors duration-200" href="{{ default "#" $item.href }}">
              <span>{{ $item.label }}</span>
              {{ if $hasChildren }}
                <i class="fa-solid fa-chevron-down text-xs transform group-hover:rotate-180 transition-transform duration-200"></i>
              {{ end }}
            </a>
            {{ if $hasChildren }}
              <div class="absolute left-0 top-full mt-2 hidden min-w-[16rem] rounded-2xl border border-gray-800/80 bg-black/95 shadow-2xl group-hover:block group-focus-within:block">
                <span class="absolute inset-x-0 -top-2 h-2 bg-transparent"></span>
                <ul class="pt-2 pb-4">
                  {{ range $child := $item.children }}
                    <li>
                      <a class="block px-5 py-2 text-gray-300 hover:text-white hover:bg-verana/10 transition-colors duration-150" href="{{ $child.href }}">
                        {{ $child.label }}
                      </a>
                    </li>
                  {{ end }}
                </ul>
              </div>
            {{ end }}
          </div>
        {{ end }}
      </nav>
      <div class="flex items-center space-x-4">
        {{ with .Site.Params.header.testnet }}
          <a href="{{ .url | default "#" }}" class="bg-verana hover:bg-verana-dark text-white px-6 py-2.5 rounded-lg font-medium transition-all duration-200 hover:scale-105 hover:shadow-lg cursor-pointer">
            {{ .label | default "Testnet" }}
          </a>
        {{ end }}
        <button id="nav-toggle" class="xl:hidden text-white" aria-label="Toggle navigation" aria-expanded="false" aria-controls="nav-menu-mobile">
          <i class="fa-solid fa-bars text-xl"></i>
        </button>
      </div>
    </div>
  </div>
  <div id="nav-menu-mobile" class="xl:hidden hidden border-t border-gray-800 bg-black/95" aria-hidden="true">
    <nav class="container mx-auto px-6 py-4 space-y-4">
      {{ range $item := $navItems }}
        {{ $hasChildren := gt (len $item.children) 0 }}
        <div>
          <a class="block text-gray-200 font-medium hover:text-white transition-colors duration-200" href="{{ default "#" $item.href }}">{{ $item.label }}</a>
          {{ if $hasChildren }}
            <ul class="mt-2 space-y-2 border-l border-gray-700/60 pl-4">
              {{ range $child := $item.children }}
                <li><a class="block text-gray-400 hover:text-white transition-colors duration-150" href="{{ $child.href }}">{{ $child.label }}</a></li>
              {{ end }}
            </ul>
          {{ end }}
        </div>
      {{ end }}
      {{ with .Site.Params.header.testnet }}
        <a href="{{ .url | default "#" }}" class="block text-center bg-verana hover:bg-verana-dark text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 hover:scale-[1.02]">
          {{ .label | default "Testnet" }}
        </a>
      {{ end }}
    </nav>
  </div>
</header>
