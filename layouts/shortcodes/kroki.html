{{/* Enhanced Kroki shortcode supporting inline source or resource files.
   Preferred params:
     - _type or type: diagram type (e.g., plantuml, mermaid, graphviz)
     - _name: path to a resource (page resource or assets/) if not using inline
     - any other attributes are forwarded to the output partial (e.g., class, style)

   Inline usage:
     {{< kroki _type="plantuml" >}}
     @startuml
     Alice -> Bob: Hello
     @enduml
     {{< /kroki >}}

   Resource usage (module-compatible):
     {{< kroki _type="plantuml" _name="diagrams/foo.puml" >}}
*/}}
{{- $name := .Get "_name" -}}
{{- $type := or (.Get "_type") (.Get "type") -}}
{{- $output := .Get "_output" -}}
{{- $source := trim .Inner "\n" -}}

{{- if not $type -}}
  {{- errorf "[kroki] no diagram type specified (_type)" -}}
{{- end -}}

{{- if eq $source "" -}}
  {{- with .Page.Resources.Get $name -}}
    {{- $source = .Content -}}
  {{- else -}}
    {{- with resources.Get $name -}}
      {{- $source = .Content -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- with $source -}}
  {{- $svg := partial "kroki/functions/svg" (dict "type" $type "source" $source) -}}
  {{- with $svg -}}
    {{ partial "kroki/output" (dict
      "svg" .
      "output" $output
      "attrs" $.Params)
    }}
  {{- end -}}
{{- end -}}

